description: >
  This command runs flake8 and security checks on a repo.
parameters:
  dir:
    description: the directory to run tests for
    type: string
    default: .
  exclude_dirs:
    description: a comma-separated list of directories or subfolders to exclude, i.e. "tests,dev"
    type: string
    default: ""
steps:
  - run:
      name: Create Environment
      command: |
        python3 -m venv security_checks_venv/
      working_directory: << parameters.dir >>
  - run:
      name: Run flake8     # Make sure each step here shows up as a separate task
      command: |
        source security_checks_venv/bin/activate
        pip install flake8
        pwd
        ls -a
      working_directory: << parameters.dir >>
  - run:
      name: Run Safety Check
      command: |
        source security_checks_venv/bin/activate
        pip install safety
        safety check
      working_directory: << parameters.dir >>
  - run:
      name: Run Bandit Check
      command: |
        source security_checks_venv/bin/activate
        pip install bandit
        EXCLUDE_DIRS=''
        IFS=','
        FOR for TEMP_EXCLUDE in << parameters.exclude_dirs >>; do
            EXCLUDE_DIRS="${EXCLUDE_DIRS} -x */${TEMP_EXCLUDE}/*"
        done
        bandit -x '*/security_checks_venv/*','*/tests/*' -r . -ll ${EXCLUDE_DIRS}
      working_directory: << parameters.dir >>
